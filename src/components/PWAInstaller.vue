<!-- src/components/PWAInstaller.vue -->
<!-- Composant pour g√©rer l'installation PWA - Version corrig√©e -->
<template>
  <div v-if="showInstaller">
    <!-- Option 1: Bouton dans menu -->
    <v-list-item 
      v-if="variant === 'menu'"
      @click="handleInstallClick"
      :disabled="isInstalled"
    >
      <template v-slot:prepend>
        <v-icon :color="getIconColor">
          {{ getIcon }}
        </v-icon>
      </template>
      <v-list-item-title>
        {{ getTitle }}
      </v-list-item-title>
      <v-list-item-subtitle v-if="!isInstalled">
        {{ getSubtitle }}
      </v-list-item-subtitle>
    </v-list-item>

    <!-- Option 2: Banner en bas d'√©cran -->
    <v-banner
      v-if="variant === 'banner' && shouldShowBanner"
      sticky
      elevation="8"
      color="primary"
      icon="mdi-download"
      class="pwa-install-banner"
    >
      <template v-slot:text>
        <div class="d-flex flex-column">
          <div class="text-subtitle-1 font-weight-medium">
            {{ t('pwa.installPrompt') }}
          </div>
          <div class="text-caption mt-1">
            {{ t('pwa.installBenefits') }}
          </div>
        </div>
      </template>
      
      <template v-slot:actions>
        <v-btn
          variant="outlined"
          size="small"
          @click="dismissBanner"
          class="mr-2"
        >
          {{ t('common.later') }}
        </v-btn>
        <v-btn
          variant="elevated"
          size="small"
          @click="handleInstallClick"
          :loading="installing"
        >
          <v-icon start>mdi-download</v-icon>
          {{ t('pwa.install') }}
        </v-btn>
      </template>
    </v-banner>

    <!-- Option 3: Snackbar discret -->
    <v-snackbar
      v-if="variant === 'snackbar'"
      v-model="showSnackbar"
      :timeout="8000"
      location="bottom"
      color="primary"
      elevation="6"
    >
      <div class="d-flex align-center">
        <v-icon start>mdi-download</v-icon>
        <span>{{ t('pwa.installAvailable') }}</span>
      </div>
      
      <template v-slot:actions>
        <v-btn
          variant="text"
          size="small"
          @click="handleInstallClick"
          :loading="installing"
        >
          {{ t('pwa.install') }}
        </v-btn>
        <v-btn
          icon="mdi-close"
          size="small"
          @click="showSnackbar = false"
        />
      </template>
    </v-snackbar>
  </div>
</template>

<script>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useI18n } from 'vue-i18n'

export default {
  name: 'PWAInstaller',
  props: {
    variant: {
      type: String,
      default: 'menu',
      validator: (value) => ['menu', 'banner', 'snackbar'].includes(value)
    },
    autoShow: {
      type: Boolean,
      default: true
    }
  },
  emits: ['installed', 'dismissed'],
  setup(props, { emit }) {
    const { t } = useI18n()
    
    // √âtat
    const deferredPrompt = ref(null)
    const isInstallable = ref(false)
    const isInstalled = ref(false)
    const installing = ref(false)
    const showSnackbar = ref(false)
    const bannerDismissed = ref(false)
    const platform = ref('unknown')
    
    // Computed
    const showInstaller = computed(() => {
      // Toujours montrer dans le menu
      if (props.variant === 'menu') return true
      
      // Pour banner et snackbar, montrer si installable et non install√©
      return isInstallable.value && !isInstalled.value
    })
    
    const shouldShowBanner = computed(() => {
      return isInstallable.value && !isInstalled.value && !bannerDismissed.value
    })
    
    const getIcon = computed(() => {
      if (isInstalled.value) return 'mdi-check-circle'
      if (platform.value === 'ios') return 'mdi-share'
      if (platform.value === 'android') return 'mdi-download'
      return 'mdi-download'
    })
    
    const getIconColor = computed(() => {
      if (isInstalled.value) return 'success'
      if (isInstallable.value) return 'primary'
      return 'grey'
    })
    
    const getTitle = computed(() => {
      if (isInstalled.value) return t('pwa.installed')
      return t('pwa.installApp')
    })
    
    const getSubtitle = computed(() => {
      if (isInstalled.value) return ''
      if (platform.value === 'ios') return t('pwa.installDescription') + ' (iOS)'
      if (platform.value === 'android') return t('pwa.installDescription') + ' (Android)'
      return t('pwa.installDescription')
    })
    
    // D√©tection de la plateforme
    const detectPlatform = () => {
      const ua = navigator.userAgent
      if (/iPad|iPhone|iPod/.test(ua)) {
        platform.value = 'ios'
      } else if (/Android/.test(ua)) {
        platform.value = 'android'
      } else if (/Windows/.test(ua)) {
        platform.value = 'windows'
      } else if (/Mac/.test(ua)) {
        platform.value = 'mac'
      } else {
        platform.value = 'desktop'
      }
    }
    
    // V√©rifier si l'app est install√©e
    const checkIfInstalled = () => {
      // M√©thode 1: Mode standalone
      if (window.matchMedia('(display-mode: standalone)').matches) {
        isInstalled.value = true
        return true
      }
      
      // M√©thode 2: iOS navigator.standalone
      if ('standalone' in window.navigator && window.navigator.standalone) {
        isInstalled.value = true
        return true
      }
      
      // M√©thode 3: URL params (pour les raccourcis)
      const urlParams = new URLSearchParams(window.location.search)
      if (urlParams.get('utm_source') === 'pwa') {
        isInstalled.value = true
        return true
      }
      
      // M√©thode 4: V√©rifier le referer
      if (document.referrer.includes('android-app://')) {
        isInstalled.value = true
        return true
      }
      
      return false
    }
    
    // V√©rifier si l'app est installable
    const checkInstallability = () => {
      // D'abord v√©rifier si d√©j√† install√©e
      if (checkIfInstalled()) {
        isInstallable.value = false
        return
      }
      
      // Crit√®res de base pour une PWA
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost'
      const hasServiceWorker = 'serviceWorker' in navigator
      const hasManifest = document.querySelector('link[rel="manifest"]')
      
      // Si tous les crit√®res sont remplis, l'app est installable
      if (isSecure && hasServiceWorker && hasManifest) {
        isInstallable.value = true
        
        // ‚úÖ IMPORTANT: Sur Chrome mobile, m√™me sans beforeinstallprompt,
        // l'option "Add to Home Screen" est disponible dans le menu
        if (platform.value === 'android' && /Chrome/.test(navigator.userAgent)) {
          console.log('üì± Chrome Android d√©tect√© - Installation via menu disponible')
        }
      }
      
      console.log('üîç V√©rification installabilit√©:', {
        isSecure,
        hasServiceWorker,
        hasManifest,
        isInstallable: isInstallable.value,
        platform: platform.value
      })
    }
    
    // Gestionnaire du prompt d'installation natif
    const handleBeforeInstallPrompt = (e) => {
      console.log('‚úÖ beforeinstallprompt captur√©!')
      e.preventDefault()
      deferredPrompt.value = e
      isInstallable.value = true
      
      // Auto-affichage du banner/snackbar apr√®s un d√©lai
      if (props.autoShow && props.variant !== 'menu') {
        setTimeout(() => {
          if (props.variant === 'banner') {
            // Banner s'affiche automatiquement via computed
          } else if (props.variant === 'snackbar') {
            showSnackbar.value = true
          }
        }, 2000)
      }
    }
    
    // Gestionnaire du clic sur installer
    const handleInstallClick = async () => {
      // Si on a le prompt natif, l'utiliser
      if (deferredPrompt.value) {
        installing.value = true
        
        try {
          deferredPrompt.value.prompt()
          const { outcome } = await deferredPrompt.value.userChoice
          
          console.log(`üì± Choix utilisateur: ${outcome}`)
          
          if (outcome === 'accepted') {
            isInstalled.value = true
            isInstallable.value = false
            showSnackbar.value = false
            bannerDismissed.value = true
            
            emit('installed')
            
            // Feedback
            if (window.navigator.vibrate) {
              window.navigator.vibrate([100, 50, 100])
            }
          }
          
          deferredPrompt.value = null
        } catch (error) {
          console.error('‚ùå Erreur installation:', error)
        } finally {
          installing.value = false
        }
      } else {
        // Sinon, afficher les instructions manuelles
        showManualInstructions()
      }
    }
    
    // Afficher les instructions manuelles
    const showManualInstructions = () => {
      let message = ''
      let icon = ''
      
      switch (platform.value) {
        case 'ios':
          message = `iOS Safari:\n1. Touchez l'ic√¥ne Partager ÙÄàÇ\n2. Choisissez "Sur l'√©cran d'accueil" ÙÄ•ê\n3. Touchez "Ajouter"`
          icon = 'mdi-share'
          break
          
        case 'android':
          message = `Chrome Android:\n1. Touchez le menu ‚ãÆ\n2. Choisissez "Ajouter √† l'√©cran d'accueil"\n3. Confirmez l'installation\n\nOU cherchez l'ic√¥ne + dans la barre d'adresse`
          icon = 'mdi-menu'
          break
          
        case 'windows':
        case 'mac':
        case 'desktop':
        default:
          message = `Chrome/Edge Desktop:\n1. Cliquez sur l'ic√¥ne + dans la barre d'adresse\n2. OU Menu ‚Üí "Installer ONUF"\n3. OU F12 ‚Üí Application ‚Üí Manifest ‚Üí Install`
          icon = 'mdi-plus'
          break
      }
      
      // √âmettre un √©v√©nement pour afficher les instructions
      const event = new CustomEvent('show-install-instructions', {
        detail: {
          instructions: message,
          isIOS: platform.value === 'ios',
          isAndroid: platform.value === 'android',
          isDesktop: !['ios', 'android'].includes(platform.value),
          platform: platform.value
        }
      })
      window.dispatchEvent(event)
    }
    
    // Rejeter le banner
    const dismissBanner = () => {
      bannerDismissed.value = true
      emit('dismissed')
      
      // Sauvegarder la pr√©f√©rence
      localStorage.setItem('onuf-pwa-banner-dismissed', Date.now().toString())
    }
    
    // V√©rifier si le banner a √©t√© rejet√©
    const checkBannerPreference = () => {
      const dismissed = localStorage.getItem('onuf-pwa-banner-dismissed')
      if (dismissed) {
        const dismissedTime = parseInt(dismissed)
        const oneWeek = 7 * 24 * 60 * 60 * 1000
        
        if (Date.now() - dismissedTime < oneWeek) {
          bannerDismissed.value = true
        }
      }
    }
    
    // Lifecycle
    onMounted(() => {
      detectPlatform()
      checkInstallability()
      checkBannerPreference()
      
      // √âcouter les √©v√©nements
      window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt)
      window.addEventListener('manual-pwa-install', handleInstallClick)
      
      // √âcouter les changements de display mode
      const displayModeQuery = window.matchMedia('(display-mode: standalone)')
      displayModeQuery.addEventListener('change', (e) => {
        if (e.matches) {
          isInstalled.value = true
          isInstallable.value = false
          console.log('‚úÖ PWA install√©e d√©tect√©e')
        }
      })
      
      // Re-v√©rifier l'installabilit√© apr√®s un d√©lai
      setTimeout(() => {
        checkInstallability()
      }, 1000)
      
      console.log('üîß PWAInstaller mont√©:', {
        variant: props.variant,
        platform: platform.value,
        isInstallable: isInstallable.value,
        isInstalled: isInstalled.value
      })
    })
    
    onUnmounted(() => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt)
      window.removeEventListener('manual-pwa-install', handleInstallClick)
    })
    
    return {
      // √âtat
      isInstalled,
      installing,
      showSnackbar,
      showInstaller,
      shouldShowBanner,
      
      // Computed
      getIcon,
      getIconColor,
      getTitle,
      getSubtitle,
      
      // M√©thodes
      handleInstallClick,
      dismissBanner,
      
      // Utils
      t
    }
  }
}
</script>

<style scoped>
.pwa-install-banner {
  position: fixed !important;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  border-radius: 12px 12px 0 0 !important;
  animation: slideUpBanner 0.3s ease-out;
}

@keyframes slideUpBanner {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Responsive */
@media (max-width: 600px) {
  .pwa-install-banner :deep(.v-banner__text) {
    font-size: 0.875rem;
  }
  
  .pwa-install-banner :deep(.v-banner__actions) {
    gap: 8px;
  }
}
</style>
